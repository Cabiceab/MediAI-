<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vyle - Sistema M√©dico IA Avanzado</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
    <style>
        /* Estilos previos... */
        .confidence-bar {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #2196F3);
            transition: width 0.3s ease;
        }
        
        .model-explanation {
            font-size: 0.9em;
            color: #666;
            border-left: 3px solid #1a73e8;
            padding-left: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
   <body>
    <div class="container py-4">
        <h1 class="text-center mb-4">ü©∫ Vyle - Asistente M√©dico IA</h1>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        Interfaz de Diagn√≥stico Inteligente
                    </div>
                    <div class="card-body">
                        <div id="chatBox" class="chat-container">
                            <div class="message bot-message">
                                <i class="fas fa-robot me-2"></i>
                                ¬°Hola! Soy Vyle, tu asistente m√©dico IA. ¬øQu√© s√≠ntomas presentas hoy?
                            </div>
                        </div>

                        <div class="input-group mb-3">
                            <input type="text" id="symptomInput" class="form-control" 
                                   placeholder="Describe tus s√≠ntomas (ej: fiebre, dolor de cabeza)..."
                                   onkeypress="handleKeyPress(event)">
                            <button class="btn btn-primary" onclick="analyzeInput()">
                                <i class="fas fa-paper-plane me-2"></i> Enviar
                            </button>
                        </div>

                        <div class="drop-zone" ondrop="handleDrop(event)" ondragover="handleDragOver(event)"
                             id="dropZone">
                            <p>Arrastra aqu√≠ im√°genes m√©dicas o <u>haz clic para seleccionar</u></p>
                            <input type="file" id="medicalImage" class="d-none" 
                                   accept="image/*" multiple onchange="handleImageUpload(event)">
                            <div class="mt-2 text-muted small">
                                Formatos soportados: JPG, PNG, DICOM
                            </div>
                        </div>
                        <div id="imagePreview" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow h-100">
                    <div class="card-header bg-success text-white">
                        <i class="fas fa-diagnoses me-2"></i> Resultados del An√°lisis
                    </div>
                    <div class="card-body">
                        <div id="resultsAccordion" class="accordion"></div>
                        <div id="loading" class="text-center mt-3" style="display: none;">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2">Analizando datos...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-4 text-center text-muted small">
            <div class="alert alert-warning d-inline-block">
                ‚ö†Ô∏è Este sistema es una herramienta de apoyo diagn√≥stico. Consulte siempre a un profesional m√©dico.
                <br>Desarrollado por Camilo Avila
            </div>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Configuraci√≥n avanzada
        const DIAGNOSIS_CACHE_SIZE = 100;
        const SYMPTOM_WEIGHTS = {
            "placa de Hollenhorst": 0.95,
            "ceguera s√∫bita": 0.90,
            "dolor tor√°cico": 0.85,
            "fiebre": 0.65,
            "tos": 0.60
        };
        // Base de datos m√©dica ampliada (100 enfermedades)
        const medicalDatabase = {
            infecciosas: {
                dengue: {code: "1D2A", symptoms: ["fiebre", "dolor cabeza", "dolor muscular", "erupcion"]},
                malaria: {code: "1F4G", symptoms: ["fiebre", "escalofrios", "sudoracion", "anemia"]},
                tuberculosis: {code: "1D2C", symptoms: ["tos persistente", "perdida peso", "sudor nocturno"]},
                zika: {code: "1D2B", symptoms: ["fiebre", "rash", "conjuntivitis", "artralgia"]},
                leishmaniasis: {code: "1F50", symptoms: ["ulcera cutanea", "fiebre", "hepatoesplenomegalia"]},
                enfermedad_chagas: {code: "1F64", symptoms: ["fiebre", "edema ocular", "miocarditis"]},
                leptospirosis: {code: "1B94", symptoms: ["fiebre alta", "mialgias", "ictericia"]},
                sifilis: {code: "1A6Z", symptoms: ["ulcera genital", "rash", "linfadenopatia"]},
                vih: {code: "1C62", symptoms: ["fiebre recurrente", "perdida peso", "linfadenopatia"]},
                hepatitisB: {code: "1E51", symptoms: ["ictericia", "astenia", "hepatomegalia"]},
                varicela: {code: "1E91", symptoms: ["vesiculas cutaneas", "prurito", "fiebre"]},
                sarampion: {code: "1E83", symptoms: ["exantema", "fiebre", "tos", "conjuntivitis"]},
                meningitis: {code: "1D01", symptoms: ["cefalea intensa", "rigidez nucal", "fotofobia"]},
                colera: {code: "1A00", symptoms: ["diarrea acuosa", "vomitos", "deshidratacion"]},
                ebola: {code: "1D60", symptoms: ["fiebre hemorragica", "dolor muscular", "hemorragias"]},
                fiebreAmarilla: {code: "1F92", symptoms: ["ictericia", "cefalea", "hemorragias"]},
                difteria: {code: "1C01", symptoms: ["dolor garganta", "fiebre", "membranas mucosas"]}
            },
            respiratorias: {
                neumonia: {code: "CA40", symptoms: ["tos con flema", "fiebre", "dificultad respirar"]},
                asma: {code: "CA23", symptoms: ["sibilancias", "disnea", "opresion toracica"]},
                epoc: {code: "CA22", symptoms: ["tos cronica", "disnea", "expectoracion"]},
                bronquiolitis: {code: "CA43", symptoms: ["taquipnea", "sibilancias", "retracciones"]},
                influenza: {code: "1C10", symptoms: ["fiebre alta", "dolor muscular", "congestion"]},
                covid19: {code: "1D8Z", symptoms: ["fiebre", "tos seca", "perdida olfato"]},
                rinitis: {code: "CA50", symptoms: ["congestion nasal", "estornudos", "picor nasal"]},
                sinusitis: {code: "CA51", symptoms: ["dolor facial", "congestion", "cefalea"]},
                fibrosisPulmonar: {code: "CA70", symptoms: ["disnea progresiva", "tos seca", "crepitantes"]}
            },
            cronicas: {
                diabetes: {code: "5A10", symptoms: ["poliuria", "polidipsia", "vision borrosa"]},
                hipertension: {code: "BA00", symptoms: ["cefalea matutina", "vision borrosa", "mareos"]},
                artritis: {code: "FA00", symptoms: ["dolor articular", "rigidez matutina", "inflamacion"]},
                epilepsia: {code: "8A60", symptoms: ["convulsiones", "perdida conciencia", "aura"]},
                cirrosis: {code: "DB90", symptoms: ["ascitis", "ictericia", "hepatomegalia"]},
                ulcera_peptica: {code: "DA60", symptoms: ["dolor epigastrico", "pirosis", "hematemesis"]},
                insuficiencia_renal: {code: "GB61", symptoms: ["edema", "oliguria", "nauseas"]},
                lupus: {code: "4A40", symptoms: ["rash facial", "artralgia", "fotosensibilidad"]},
                parkinson: {code: "8A20", symptoms: ["temblor reposo", "rigidez", "bradicinesia"]},
                esclerosisMultiple: {code: "8A50", symptoms: ["vision doble", "parestesias", "debilidad"]}
            },
            gastrointestinales: {
                gastritis: {code: "DA50", symptoms: ["dolor epigastrico", "nauseas", "pirosis"]},
                apendicitis: {code: "DC30", symptoms: ["dolor cuadrante inferior derecho", "fiebre", "nauseas"]},
                fiebre_tifoidea: {code: "1A07", symptoms: ["fiebre escalofrios", "dolor abdominal", "estupor"]},
                parasitosis: {code: "1F90", symptoms: ["dolor abdominal", "diarrea", "prurito anal"]},
                colitis: {code: "DD70", symptoms: ["dolor abdominal", "diarrea con sangre", "tenesmo"]},
                enfermedadCrohn: {code: "DD60", symptoms: ["dolor abdominal", "diarrea", "perdida peso"]},
                hepatitis: {code: "DB20", symptoms: ["ictericia", "astenia", "coluria"]},
                pancreatitis: {code: "DC40", symptoms: ["dolor epigastrico", "nauseas", "distension"]},
                reflujo: {code: "DA40", symptoms: ["pirosis", "regurgitacion", "dolor toracico"]},
                sindromeColonIrritable: {code: "DD90", symptoms: ["dolor abdominal", "distension", "alteracion ritmo intestinal"]}
            },
            cardiovasculares: {
                infarto: {code: "BA40", symptoms: ["dolor toracico", "sudoracion", "disnea"]},
                arritmia: {code: "BC50", symptoms: ["palpitaciones", "mareo", "sincope"]},
                insuficienciaCardiaca: {code: "BA50", symptoms: ["disnea", "edema", "fatiga"]},
                angina: {code: "BA30", symptoms: ["dolor toracico esfuerzo", "palpitaciones", "sudoracion"]},
                aneurisma: {code: "BA60", symptoms: ["dolor abdominal", "pulsacion abdominal", "hipotension"]},
                trombosis: {code: "BD30", symptoms: ["edema unilateral", "dolor pierna", "enrojecimiento"]},
                varices: {code: "BD50", symptoms: ["dolor piernas", "edema", "ulceras"]}
            },
            neurologicas: {
                migra√±a: {code: "8A10", symptoms: ["cefalea puls√°til", "fotofobia", "nausea"]},
                alzheimer: {code: "8A30", symptoms: ["perdida memoria", "desorientacion", "cambios personalidad"]},
                meningitis: {code: "1D01", symptoms: ["rigidez nucal", "fotofobia", "cefalea"]},
                neuralgia: {code: "8B10", symptoms: ["dolor neurop√°tico", "parestesias", "hipersensibilidad"]},
                accidenteCerebrovascular: {code: "8B20", symptoms: ["debilidad unilateral", "dificultad hablar", "perdida vision"]}
            },
            pediatricas: {
                desnutricion: {code: "5B50", symptoms: ["bajo peso", "edema", "cabello quebradizo"]},
                rubeola: {code: "1E82", symptoms: ["exantema", "linfadenopatia", "fiebre leve"]},
                tosferina: {code: "1C10", symptoms: ["tos paroxistica", "estridor", "cianosis"]},
                paperas: {code: "1E90", symptoms: ["inflamacion parotidas", "fiebre", "dolor mandibular"]},
                escarlatina: {code: "1C20", symptoms: ["lengua fresa", "exantema", "faringitis"]},
                varicela: {code: "1E91", symptoms: ["vesiculas", "prurito", "fiebre"]},
                bronquiolitis: {code: "CA43", symptoms: ["sibilancias", "taquipnea", "retracciones"]}
            },
            obstetricas: {
                preeclampsia: {code: "JA24", symptoms: ["hipertension", "proteinuria", "edema"]},
                sepsis_puerperal: {code: "JB63", symptoms: ["fiebre", "dolor abdominal", "secrecion vaginal"]},
                diabetesGestacional: {code: "5A20", symptoms: ["poliuria", "sed excesiva", "fatiga"]},
                placentaPrevia: {code: "JA30", symptoms: ["sangrado indoloro", "contracciones", "anemia"]},
                abortoEspontaneo: {code: "JA40", symptoms: ["sangrado vaginal", "dolor abdominal", "tejido expulsado"]}
            },
            oncologicas: {
                cancerMama: {code: "2C60", symptoms: ["masa mamaria", "retraccion pezon", "linfadenopatia"]},
                cancerProstata: {code: "2C82", symptoms: ["disuria", "hematuria", "dolor osseo"]},
                cancerPulmon: {code: "2C30", symptoms: ["tos persistente", "hemoptisis", "perdida peso"]},
                cancerColon: {code: "2C90", symptoms: ["sangrado rectal", "cambio ritmo intestinal", "anemia"]},
                leucemia: {code: "2B50", symptoms: ["fatiga", "infecciones recurrentes", "petequias"]}
            },
            dermatologicas: {
                psoriasis: {code: "EA10", symptoms: ["placas eritematosas", "descamacion", "prurito"]},
                eczema: {code: "EA20", symptoms: ["eritema", "vesiculas", "costras"]},
                acne: {code: "EA30", symptoms: ["comedones", "pustulas", "quistes"]},
                urticaria: {code: "EA40", symptoms: ["ronchas pruriginosas", "angioedema", "picazon"]}
            },
            endocrinas: {
                hipertiroidismo: {code: "5A30", symptoms: ["perdida peso", "taquicardia", "temblor"]},
                hipotiroidismo: {code: "5A40", symptoms: ["aumento peso", "fatiga", "piel seca"]},
                enfermedadAddison: {code: "5A50", symptoms: ["hiperpigmentacion", "hipotension", "fatiga"]},
                cushing: {code: "5A60", symptoms: ["cara de luna", "giba dorsal", "estr√≠as"]}
            },
            osteomusculares: {
                osteoporosis: {code: "FB00", symptoms: ["dolor oseo", "fracturas", "perdida altura"]},
                fibromialgia: {code: "FB10", symptoms: ["dolor generalizado", "fatiga", "puntos dolorosos"]},
                tendinitis: {code: "FB20", symptoms: ["dolor articular", "inflamacion", "limitacion movimiento"]},
                lumbalgia: {code: "FB30", symptoms: ["dolor lumbar", "rigidez", "limitacion movimiento"]}
            },
            psiquiatricas: {
                depresion: {code: "6A70", symptoms: ["tristeza", "anhedonia", "cambios sue√±o"]},
                ansiedad: {code: "6B00", symptoms: ["preocupacion excesiva", "taquicardia", "sudoracion"]},
                esquizofrenia: {code: "6A20", symptoms: ["alucinaciones", "delirios", "desorganizacion"]},
                trastornoBipolar: {code: "6A60", symptoms: ["episodios maniacos", "depresion", "insomnio"]}
            }
        };

        // Matriz de s√≠ntomas completa
        const symptomMatrix = {
            "fiebre": [
                {code: "1D2A", p:0.8}, {code: "1F4G", p:0.7}, {code: "1D2C", p:0.6},
                {code: "1B94", p:0.5}, {code: "1E91", p:0.4}, {code: "1A07", p:0.6}
            ],
            "dolor cabeza": [
                {code: "1D2A", p:0.6}, {code: "8A10", p:0.7}, {code: "1D01", p:0.8}
            ],
            "tos persistente": [
                {code: "1B1Z", p:0.95}, {code: "CA40", p:0.85}, {code: "2C30", p:0.7}
            ],
            "nauseas": [
                {code: "DA50", p:0.7}, {code: "DC30", p:0.6}, {code: "1A07", p:0.5}
            ],
            "dolor abdominal": [
                {code: "1D50", p:0.9}, {code: "1A07", p:0.7}, {code: "DA60", p:0.6}
            ],
            "erupcion": [
                {code: "1D2A", p:0.7}, {code: "1E82", p:0.8}, {code: "EA10", p:0.6}
            ],
            "ictericia": [
                {code: "1E51", p:0.9}, {code: "DB90", p:0.8}, {code: "1B94", p:0.7}
            ],
            "disnea": [
                {code: "CA23", p:0.8}, {code: "BA50", p:0.7}, {code: "CA40", p:0.6}
            ],
            "convulsiones": [
                {code: "8A60", p:0.95}, {code: "1D60", p:0.6}, {code: "8A30", p:0.5}
            ]
        };

      class AdvancedDiagnosticModel {
            constructor() {
                this.model = null;
                this.cache = new SymptomCache(DIAGNOSIS_CACHE_SIZE);
                this.initModel();
            }

            async initModel() {
                this.model = tf.sequential({
                    layers: [
                        tf.layers.dense({units: 64, activation: 'relu', inputShape: [Object.keys(SYMPTOM_WEIGHTS).length]}),
                        tf.layers.dense({units: 32, activation: 'relu'}),
                        tf.layers.dense({units: Object.keys(medicalKnowledgeBase.diseases).length, activation: 'softmax'})
                    ]
                });

                this.model.compile({
                    optimizer: 'adam',
                    loss: 'categoricalCrossentropy',
                    metrics: ['accuracy']
                });

                // Entrenamiento inicial con datos sint√©ticos
                const {inputs, labels} = this.generateTrainingData();
                await this.model.fit(inputs, labels, {
                    epochs: 20,
                    batchSize: 32,
                    validationSplit: 0.2
                });
            }

            generateTrainingData() {
                // Generador de datos de entrenamiento sint√©ticos
                const symptomKeys = Object.keys(SYMPTOM_WEIGHTS);
                const diseaseKeys = Object.keys(medicalKnowledgeBase.diseases);
                
                const inputs = [];
                const labels = [];
                
                for(let i = 0; i < 1000; i++) {
                    const input = symptomKeys.map(() => Math.random() > 0.8 ? 1 : 0);
                    const labelIndex = Math.floor(Math.random() * diseaseKeys.length);
                    const label = new Array(diseaseKeys.length).fill(0);
                    label[labelIndex] = 1;
                    
                    inputs.push(input);
                    labels.push(label);
                }
                
                return {
                    inputs: tf.tensor2d(inputs),
                    labels: tf.tensor2d(labels)
                };
            }

            async diagnose(symptoms) {
                const cached = this.cache.get(symptoms);
                if(cached) return cached;

                // An√°lisis bayesiano
                const bayesianResults = this.bayesianAnalysis(symptoms);
                
                // Predicci√≥n del modelo de ML
                const mlInput = this.prepareMLInput(symptoms);
                const mlPrediction = this.model.predict(mlInput);
                const mlResults = await this.processMLOutput(mlPrediction);
                
                // Combinaci√≥n de resultados
                const combinedResults = this.combineResults(bayesianResults, mlResults);
                
                this.cache.set(symptoms, combinedResults);
                return combinedResults;
            }

            prepareMLInput(symptoms) {
                const symptomVector = Object.keys(SYMPTOM_WEIGHTS).map(
                    symptom => symptoms.includes(symptom) ? 1 : 0
                );
                return tf.tensor2d([symptomVector]);
            }

            async processMLOutput(prediction) {
                const data = await prediction.data();
                return Object.keys(medicalKnowledgeBase.diseases).map((code, index) => ({
                    code,
                    confidence: data[index],
                    source: 'ML Model'
                }));
            }

            bayesianAnalysis(symptoms) {
                return Object.entries(medicalKnowledgeBase.diseases).map(([code, disease]) => ({
                    code,
                    confidence: this.calculateBayesianProbability(symptoms, disease),
                    source: 'Bayesian Analysis'
                }));
            }

            calculateBayesianProbability(symptoms, disease) {
                let probability = disease.baseRate;
                
                symptoms.forEach(symptom => {
                    const pSymptomGivenDisease = disease.symptoms[symptom] || 0;
                    const pSymptomGeneral = medicalKnowledgeBase.symptomPrevalence[symptom] || 0.0001;
                    const weight = SYMPTOM_WEIGHTS[symptom] || 0.7;
                    
                    if(pSymptomGivenDisease > 0 && pSymptomGeneral > 0) {
                        probability *= (pSymptomGivenDisease * weight) / pSymptomGeneral;
                    }
                });
                
                return Math.min(probability, 1);
            }

            combineResults(bayesian, ml) {
                const combined = {};
                
                bayesian.forEach(result => {
                    combined[result.code] = (combined[result.code] || 0) + result.confidence * 0.6;
                });
                
                ml.forEach(result => {
                    combined[result.code] = (combined[result.code] || 0) + result.confidence * 0.4;
                });
                
                return Object.entries(combined)
                    .map(([code, confidence]) => ({
                        code,
                        confidence,
                        ...this.getDiseaseInfo(code)
                    }))
                    .sort((a, b) => b.confidence - a.confidence)
                    .slice(0, 5);
            }

            getDiseaseInfo(code) {
                const disease = medicalKnowledgeBase.diseases[code];
                return {
                    name: disease?.name || "Condici√≥n desconocida",
                    category: disease?.category || "General",
                    urgency: disease?.urgency || "Moderada"
                };
            }
        }

        class SymptomCache {
            constructor(maxSize = 100) {
                this.maxSize = maxSize;
                this.cache = new Map();
            }

            get(key) {
                if(!this.cache.has(key)) return null;
                const value = this.cache.get(key);
                this.cache.delete(key);
                this.cache.set(key, value);
                return value;
            }

            set(key, value) {
                if(this.cache.size >= this.maxSize) {
                    const oldestKey = this.cache.keys().next().value;
                    this.cache.delete(oldestKey);
                }
                this.cache.set(key, value);
            }
        }

        class VyleAIAssistant {
            constructor() {
                this.diagnosticModel = new AdvancedDiagnosticModel();
                // Resto de inicializaci√≥n...
            }

            async processInput(text, images = []) {
                showLoading(true);
                
                if(text) {
                    this.addMessage(text, 'user');
                    const symptoms = this.normalizeInput(text);
                    const diagnosis = await this.diagnosticModel.diagnose(symptoms);
                    this.showDiagnosis(diagnosis);
                }

                // Resto del procesamiento...
            }

            showDiagnosis(results) {
                const accordion = document.getElementById('resultsAccordion');
                accordion.innerHTML = results.map((result, index) => `
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#diagnosis-${index}">
                                ${result.name} (${Math.round(result.confidence * 100)}%)
                                <span class="badge bg-${result.urgency === 'Cr√≠tica' ? 'danger' : 'warning'} ms-2">
                                    ${result.urgency}
                                </span>
                            </button>
                        </h2>
                        <div id="diagnosis-${index}" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: ${result.confidence * 100}%"></div>
                                </div>
                                
                                <div class="model-explanation">
                                    <i class="fas fa-brain me-1"></i>
                                    Confianza calculada mediante:
                                    <ul>
                                        <li>An√°lisis bayesiano (60%)</li>
                                        <li>Modelo de aprendizaje profundo (40%)</li>
                                    </ul>
                                </div>
                                
                                <p><strong>Categor√≠a:</strong> ${result.category}</p>
                                <div class="alert alert-${result.urgency === 'Cr√≠tica' ? 'danger' : 'warning'}">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    ${this.getRecommendation(result)}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // Resto de m√©todos...
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            window.vyleAI = new VyleAIAssistant();
            appendMessage('<i class="fas fa-robot me-2"></i> Sistema diagn√≥stico avanzado inicializado', 'bot');
        });
    </script>
</body>
</html>
